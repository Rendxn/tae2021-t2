---
title: "Pruebas"
author: "Arley"
date: "25/4/2021"
output: html_document
---

```{r,echo=FALSE, warning=FALSE, message = FALSE}
library(scales)
library(kableExtra)
library(dplyr)
library(ape)
library(ggplot2)
```
Este trabajo requiere llevar a cabo un ejercicio de segmentación para una base de datos simulada que contiene información de clientes corporativos de una empresa cuyos clientes son empresas.

El trabajo de agrupamiento debe considerar dos tipos de variables:

* De comportamiento de los clientes en los diferentes canales y productos de la empresa 

* De estados financieros de los clientes 

$La\quad variable\quad nit\quad identifica\quad a\quad cada\quad cliente$

Se debe proponer una segmentación que le permita a la empresa entender mejor a sus clientes, identificar patrones de uso de productos y canales y su relación con los estados financieros



```{r setup, include=FALSE}
datos <-read.csv('base_trabajo_segmentacion.csv',header = TRUE, sep = ";")
```

| De comportamiento de los clientes canales y productos de la empresa|
|:-------------------------------------------------------------------|
|en: entrada                                                         |
|vm: valor medio anual                                               |
|tx: transacciones mensuales promedio                                |
|sal: salida                                                         |


|De estados financieros de los clientes |
|:------------------------------------- |
|impo_cv: [importaciones]/[compras] categorizadas|
|expo_vt: [exportaciones]/[ventas] categorizadas|
|cxp: [cuentas por pagar] categorizada con seis niveles|
|cxc: [cuentas por cobrar] categorizada con seis niveles|
|totalinventory: [valor de inventarios] categorizada con seis niveles|
|pagos_pj: [pagos hechos a personas jurídicas]/[pagos totales]|
|pagos_pn: [pagos hechos a personas naturales]/[pagos totales]|
|tiene_ventas_fisicas: la empresa tiene puntos de venta físicos (1:Si, 0:No)|
|tiene_ventas_electronicas: la empresa tiene ventas electrónicas (1:Si, 0:No)|
|recaudos_pj: [recaudos provenientes de personas jurídicas]/[recaudos totales]|
|recaudos_pn: [recaudos provenientes de personas naturales]/[recaudos totales]|
|rotacion_inventarios: [rotación de inventarios en días] categorizada con seis nivel|
|rotacion_cxc: [rotación de cuentas por pagar en días] categorizada con seis niveles
|rotacion_cxp: [rotación de cuentas por cobrar en días] categorizada con seis nivele|
|ciclo_negocio: [ciclo de negocio en días] categorizada con seis niveles    |
|ciclo_financiero: [ciclo financiero en días] categorizada con seis niveles|

```{r,echo= FALSE}
datos_num <- datos[,c(2:31)]
datos_cat<- datos[,c(32:47)]
```

```{r}
base_num_log = log(datos_num)
```

```{r}
pca<- prcomp(datos_num , scale = TRUE)
```



# Identificación de canales transacciones mensuales promedio
 
```{r, echo = FALSE }
canales_entrada_salida_tx<-datos_num %>% select(matches("._tx_."))
canales_entrada_salida_vm<-datos_num %>% select(matches("._vm_."))
# canales_vm<-datos_num %>% select(starts_with("en_tx_"))
# canales_tr_m<-datos_num %>% select(starts_with("sal_vm_"))
# canales_salida<-datos_num %>% select(starts_with("sal_tx_"))
# 
# valor medio anual                  
# transacciones mensuales promedio   
#  salida                         

```





```{r, echo = FALSE }
kbl(summary(canales_entrada_salida_tx[,c(1:5)])) %>% kable_styling()

```
```{r, echo = FALSE }
kbl(summary(canales_entrada_salida_tx[,c(6:10)])) %>% kable_styling()
```

```{r, echo = FALSE }
kbl(summary(canales_entrada_salida_tx[,c(11:15)])) %>% kable_styling()
```

Se muestran diagramas de barras para cada media de las variables en los canales de salida y los canales de entrada


* Medias de canales entrada y salida para transacciones mensuales promedio 

```{r, echo= FALSE}
medias_num_tx<- colMeans(canales_entrada_salida_tx[sapply(canales_entrada_salida_tx, is.numeric)])
barplot(medias_num_tx,las=2,cex.axis=0.8,cex.names=0.6, main = "Medias de canales entrada y salida para transacciones mensuales promedio")
```

# Identificación de canales valor medio anual

```{r, echo = FALSE }
kbl(summary(canales_entrada_salida_vm[,c(1:5)])) %>% kable_styling()
```


```{r, echo = FALSE }
kbl(summary(canales_entrada_salida_vm[,c(6:10)])) %>% kable_styling()
```


```{r, echo = FALSE }
kbl(summary(canales_entrada_salida_vm[,c(11:15)])) %>% kable_styling()
```


```{r,echo = FALSE}

medias_num_vm<- colMeans(canales_entrada_salida_vm[sapply(canales_entrada_salida_vm, is.numeric)])
barplot(medias_num_vm,las=2,cex.axis=0.8,cex.names=0.6, main = "Medias de canales entrada y salida valor medio")
```



## Normalizamos los datos tanto numericos como categoricos 

```{r}
datos_num_scaled <- scale(datos_num,center = TRUE, scale = TRUE)
datos_cat_scaled <- scale(datos_cat,center = TRUE, scale = TRUE)
#medias_num_scaled<- colMeans(datos_num_scaled) #codigo para tomar las medias escaladas 
```

## calculamos las distancias

```{r}
D_cat <- dist(datos_cat,method="binary",diag=TRUE)
D_num <- dist(datos_num_scaled,diag=TRUE)
D_Tot <- D_cat + D_num

```

# Realizamos agrupamiento jerarquico para identificar los grupos 

## ¿Qué metodo debemos usar para el agrupamiento?

Se usa medida de distancia cofonetica encargada de calcular la distancia entre las 2 ramas principales de los cluster segun cada metodo y por metodo del cenrtoide buscamos el que tenga mayor correlacion entre la matriz de ditancias 


tomado de \href[https://rpubs.com/lhromeroj/analisisdeclusterR](Busqueda del mejor metodo )


```{r}

hc_euclidea_complete <- hclust(d = D_Tot, method = "complete")
hc_euclidea_average  <- hclust(d = D_Tot , method = "average")
hc_euclidea_single  <- hclust(d = D_Tot , method = "single")
hc_euclidea_ward.D2  <- hclust(d = D_Tot , method = "ward.D2")
hc_euclidea_median  <- hclust(d = D_Tot , method = "median")
hc_euclidea_centroid  <- hclust(d =D_Tot , method = "centroid")
hc_euclidea_mcquitty  <- hclust(d =D_Tot , method = "mcquitty")

```

```{r}
cor(x = D_Tot, cophenetic(hc_euclidea_complete))
```
```{r}
cor(x = D_Tot, cophenetic(hc_euclidea_average))
```
```{r}
cor(x = D_Tot, cophenetic(hc_euclidea_single))
```

```{r}
cor(x = D_Tot, cophenetic(hc_euclidea_ward.D2))
```

```{r}
cor(x = D_Tot, cophenetic(hc_euclidea_median))
```

```{r}
cor(x = D_Tot, cophenetic(hc_euclidea_centroid)) ## Tiene la mayor correlación
```

```{r}
cor(x = D_Tot, cophenetic(hc_euclidea_mcquitty))
```

Se puede ver que el mejor metodo es euclidea average el cual toma el promedio de las distancias entre 2 puntos de diferentes grupos 

```{r}
cluster_jerar <- hclust(D_Tot,method = "ward.D2") #mejores resultados con ward.D y ward.D2
hcd <- as.dendrogram(cluster_jerar)
#plot(cut(hcd, h = 40)$upper, main = "Upper tree of cut at h=75",leaflab = "none")
plot(hcd, cex = 0.6, leaflab = "none",main = "Dendrograma de agrupamiento")
```

## ¿Qué cantidad de rgupos debemos generar en el agrupamiento?





Veamos cuales serian los primeros 5 grupos 

```{r}
hcd <- as.dendrogram(cluster_jerar)
plot(hcd, cex = 0.6, leaflab = "none")
rect.hclust(cluster_jerar, k = 5, border = 2:5)
```

Con el fin de identificar las caracteristicas de los grupos "padre" se toman los dos grupos y con el calculo de la media se identifica la diferencia entre los 2 grupos 

```{r}
etiqueta_grupo<- cutree(cluster_jerar,k=2)
```

```{r}
hcd <- as.dendrogram(cluster_jerar)
plot(hcd, cex = 0.6, leaflab = "none")
rect.hclust(cluster_jerar, k = 2, border = 2:5)
```

Se puede ver que el grupo 1 cuenta con aproximadamente el 80% de los datos

```{r}
kable(table(etiqueta_grupo),caption = "Conteo de los primeros 2 grupos")
```


Dado que la cantidad de variables es extensa el analisis y la identificacion de las diferencias entre grupos se torna complejo, de esta manera se toma la media de cada variable para cada grupo, asi se puede ver que las caracteristicas son dominadas por el promedio de la cantidad de recursos tramitados por cada canal.

```{r}

grupo1<-as.matrix(summary(datos[etiqueta_grupo==1,])[4,])
grupo2 <- as.matrix(summary(datos[etiqueta_grupo==2,])[4,])
tabla_medias_2_grupos <- cbind(grupo1,grupo2)
kable(tabla_medias_2_grupos)

```
```{r, echo = FALSE}
# Grafica de todos los grupos en conjunto  

# grafica_grupos_num<-function(Num_group){
#   
#   etiqueta_grupo<- cutree(cluster_jerar,k=Num_group)
#   
#   means_num<- aggregate(cbind(en_vm_canal1,en_vm_canal2 ,en_vm_canal3,en_vm_canal4,en_vm_canal5,en_vm_canal6,en_vm_canal7,en_vm_canal8,en_vm_canal9,en_vm_canal10,en_vm_otros,en_tx_canal1, en_tx_canal2,en_tx_canal3,en_tx_canal4,en_tx_canal5 , en_tx_canal6,en_tx_canal7,en_tx_canal8,en_tx_canal9,en_tx_canal10,en_tx_otros,sal_vm_canal5,sal_vm_canal2, sal_vm_canal8,sal_vm_otros,sal_tx_canal5,sal_tx_canal2,sal_tx_canal8,sal_tx_otros)~etiqueta_grupo,data=datos_num_scaled,FUN=sd)
#   
#   medias_grupo_1_2_cat<-data.frame(t(means_num[-1]))
#     
#   names = c(names(means_num))
#   
#   return(barplot(t(as.matrix(medias_grupo_1_2_cat)),
#                  names.arg=names[2:31],las=2,cex.axis=0.8,cex.names=0.6,
#                  col = 1:Num_group,legend = paste("Grupo", 1:Num_group),
#                  beside=TRUE))
#          
# }
```

## Analisis de los 5 grupos respecto a sus medias 

* Transacciones mensuales promedio 



El promedio de las transacciones esta dominado en su mayoria por el grupo numero 2 dado que usa todos los canales y mucho mas que los demas gurpo, el valor promedio del uso mensual indica que pueden ser empresas con alto movimiento economico para valores altos, ademas, podemos ver que el grupo 2 genera muy poco movimiento a travez de los canales de entrada numero 10 y numero 6 
```{r, echo = FALSE}

grafica_grupos_num_vm<-function(Num_group){
  
  etiqueta_grupo<- cutree(cluster_jerar,k=Num_group)
  
  means_num<- aggregate(cbind(en_vm_canal1,en_vm_canal2 ,en_vm_canal3,
                              en_vm_canal4,en_vm_canal5,en_vm_canal6,
                              en_vm_canal7,en_vm_canal8,en_vm_canal9,
                              en_vm_canal10,en_vm_otros ,sal_vm_canal5,
                              sal_vm_canal2, sal_vm_canal8,sal_vm_otros)~etiqueta_grupo,
                        data=datos_num_scaled,FUN=sd)
  
  medias_grupo_1_2_cat<-data.frame(t(means_num[-1]))
    
  names = c(names(means_num))
  par(mar=c(8,4,4,4))
  
  return(barplot(t(as.matrix(medias_grupo_1_2_cat)),
                 names.arg=names[2:16],las=2,cex.axis=0.8,cex.names=0.6,
                 col = 1:Num_group,
                 legend = paste("Grupo", 1:Num_group),ylim = c(0,11),
                 args.legend = list(bty = "n", x = "top", ncol = 3),
                 beside=TRUE, main = "Medias por grupos valor medio anual"))
         
}
```

```{r, echo = FALSE}

grafica_grupos_num_tx<-function(Num_group){
  
  etiqueta_grupo<- cutree(cluster_jerar,k=Num_group)
  
  means_num<- aggregate(cbind(en_tx_canal1, en_tx_canal2,en_tx_canal3,en_tx_canal4,
                              en_tx_canal5 , en_tx_canal6,en_tx_canal7,en_tx_canal8,
                              en_tx_canal9,en_tx_canal10,en_tx_otros,
                              sal_tx_canal5,sal_tx_canal2,
                              sal_tx_canal8,sal_tx_otros)~etiqueta_grupo,
                        data=datos_num_scaled,FUN=sd)
  
  medias_grupo_1_2_cat<-data.frame(t(means_num[-1]))
    
  names = c(names(means_num))
  par(mar=c(8,4,4,4))
  
  return(barplot(t(as.matrix(medias_grupo_1_2_cat)),
                 names.arg=names[2:16],las=2,cex.axis=0.8,cex.names=0.6,
                 col = 1:Num_group,
                 legend = paste("Grupo", 1:Num_group),ylim = c(0,13),
                 args.legend = list(bty = "n", x = "top", ncol = 3),
                 beside=TRUE,main = "Medias por grupos de transacciones mensuales promedio"))
         
}
```


```{r,echo = FALSE}

grafica_grupos_cat<-function(Num_group){
  
  etiqueta_grupo<- cutree(cluster_jerar,k=Num_group)
  
  means_num<- aggregate(cbind(impo_cv,expo_vt,cxp,cxc,totalinventory,
                              pagos_pj,pagos_pn,tiene_ventas_fisicas,
                              tiene_ventas_electronicas,recaudos_pj,
                              recaudos_pn,rotacion_inventarios,rotacion_cxc,
                              rotacion_cxp, ciclo_negocio,ciclo_financiero)~etiqueta_grupo,
                        data=datos_cat_scaled,FUN=sd)
  
  medias_grupo_1_2_cat<-data.frame(t(means_num[-1]))
    
  names = c(names(means_num))
  par(mar=c(8,4,4,4))
  return(barplot(t(as.matrix(medias_grupo_1_2_cat)),
                 names.arg=names[2:17],las=2,cex.axis=0.8,cex.names=0.6,
                 col = 1:Num_group,
                 legend = (paste("Grupo", 1:Num_group)),ylim = c(0,3),
                 args.legend = list(bty = "n", x = "top", ncol = 3),
                 beside=TRUE, main = "Medias de variables categoricas por grupos"))
         
}
```

```{r, echo = FALSE}
grafica_grupos_num_tx(5)
```


```{r, echo = FALSE}
grafica_grupos_num_vm(5)
```

```{r, echo = FALSE}
grafica_grupos_cat(5)
```

```{r}
set.seed(1234)
wcss <- vector()
for(i in 1:20){
  wcss[i] <- sum(kmeans(D_Tot, i)$withinss)
}
```

```{r}
plot(wcss)
```
```{r}
# set.seed(1234)
# wcss_20 <- vector()
# for(i in 1:20){
#   wcss[i] <- sum(kmeans(D_cat, i)$withinss)
# }
```


```{r}
#cluster_jerar_num <- hclust(D_num,method = "complete")
```
```{r}
#plot(cluster_jerar_num)
```
```{r}
# set.seed(1234)
# wcss_num <- vector()
# for(i in 1:10){
#   wcss[i] <- sum(kmeans(D_num, i)$withinss)
# }
```





```{r}
#cluster_jerar_num <- hclust(D_num,method = "complete")
```
```{r}
#plot(cluster_jerar_num )
```
```{r}
#etiqueta_grupo <- cutree(cluster_jerar,k=5)
```
```{r}
#plot(etiqueta_grupo )
```





